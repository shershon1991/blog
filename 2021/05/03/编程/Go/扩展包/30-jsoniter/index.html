<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Go扩展包(三十):jsoniter | 码农小山</title><meta name="keywords" content="Go扩展包"><meta name="author" content="谭晓珊,18810877074@163.com"><meta name="copyright" content="谭晓珊"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1. 介绍json-iterator是一款快且灵活的JSON解析器,不但100%兼容标准库encoding&#x2F;json,而且比其更快。虽然官网说比标准包encoding&#x2F;json快6倍之多，但是随着Go版本的不断迭代，目前平均比encoding&#x2F;json快2倍。 官网给出的性能对比结果如下: 1.1 官网性能对比图 1.2 自写程序验证12345678910➜  go-study-example g">
<meta property="og:type" content="article">
<meta property="og:title" content="Go扩展包(三十):jsoniter">
<meta property="og:url" content="http://blog.shershon.top/2021/05/03/%E7%BC%96%E7%A8%8B/Go/%E6%89%A9%E5%B1%95%E5%8C%85/30-jsoniter/index.html">
<meta property="og:site_name" content="码农小山">
<meta property="og:description" content="1. 介绍json-iterator是一款快且灵活的JSON解析器,不但100%兼容标准库encoding&#x2F;json,而且比其更快。虽然官网说比标准包encoding&#x2F;json快6倍之多，但是随着Go版本的不断迭代，目前平均比encoding&#x2F;json快2倍。 官网给出的性能对比结果如下: 1.1 官网性能对比图 1.2 自写程序验证12345678910➜  go-study-example g">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/shershon1991/picImgBed/master/personal/21358691.jpeg">
<meta property="article:published_time" content="2021-05-02T16:00:00.000Z">
<meta property="article:modified_time" content="2023-03-07T02:54:01.463Z">
<meta property="article:author" content="谭晓珊">
<meta property="article:tag" content="Go扩展包">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/shershon1991/picImgBed/master/personal/21358691.jpeg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://blog.shershon.top/2021/05/03/%E7%BC%96%E7%A8%8B/Go/%E6%89%A9%E5%B1%95%E5%8C%85/30-jsoniter/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"TTENARPLYL","apiKey":"9f0c02b55e9885568dcbf6ef094b433c","indexName":"hexo","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Go扩展包(三十):jsoniter',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-03-07 10:54:01'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://raw.githubusercontent.com/shershon1991/picImgBed/master/personal/21358691.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">177</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">35</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">23</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 资源</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">码农小山</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 资源</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Go扩展包(三十):jsoniter</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-05-02T16:00:00.000Z" title="发表于 2021-05-03 00:00:00">2021-05-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-03-07T02:54:01.463Z" title="更新于 2023-03-07 10:54:01">2023-03-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B/Go/">Go</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Go扩展包(三十):jsoniter"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2021/05/03/%E7%BC%96%E7%A8%8B/Go/%E6%89%A9%E5%B1%95%E5%8C%85/30-jsoniter/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2021/05/03/%E7%BC%96%E7%A8%8B/Go/%E6%89%A9%E5%B1%95%E5%8C%85/30-jsoniter/" itemprop="commentCount"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div><article class="post-content" id="article-container"><h1 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h1><p><code>json-iterator</code>是一款快且灵活的<code>JSON</code>解析器,不但<code>100%</code>兼容标准库<code>encoding/json</code>,而且比其更快。虽然官网说比标准包<code>encoding/json</code>快6倍之多，但是随着<code>Go</code>版本的不断迭代，目前平均比<code>encoding/json</code>快2倍。</p>
<p>官网给出的性能对比结果如下:</p>
<h2 id="1-1-官网性能对比图"><a href="#1-1-官网性能对比图" class="headerlink" title="1.1 官网性能对比图"></a>1.1 官网性能对比图</h2><p><img src="https://raw.githubusercontent.com/shershon1991/picImgBed/master/go/img/687474703a2f2f6a736f6e697465722e636f6d2f62656e63686d61726b732f676f2d62656e63686d61726b2e706e67.png" alt="性能图"></p>
<h2 id="1-2-自写程序验证"><a href="#1-2-自写程序验证" class="headerlink" title="1.2 自写程序验证"></a>1.2 自写程序验证</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="keyword">go</span>-study-example git:(main) ✗ <span class="keyword">go</span> test -bench=. test/jsoniter_test.<span class="keyword">go</span> -benchmem</span><br><span class="line">goos: darwin</span><br><span class="line">goarch: amd64</span><br><span class="line">cpu: Intel(R) Core(TM) i7<span class="number">-8750</span>H CPU @ <span class="number">2.20</span>GHz</span><br><span class="line">BenchmarkUnMarshalIter<span class="number">-12</span>         <span class="number">559245</span>              <span class="number">2126</span> ns/op            <span class="number">1240</span> B/op         <span class="number">39</span> allocs/op</span><br><span class="line">BenchmarkUnMarshalJson<span class="number">-12</span>         <span class="number">218618</span>              <span class="number">5390</span> ns/op            <span class="number">1448</span> B/op         <span class="number">33</span> allocs/op</span><br><span class="line">BenchmarkMarshalIter<span class="number">-12</span>           <span class="number">629608</span>              <span class="number">1988</span> ns/op            <span class="number">1121</span> B/op         <span class="number">11</span> allocs/op</span><br><span class="line">BenchmarkMarshal<span class="number">-12</span>               <span class="number">528918</span>              <span class="number">2295</span> ns/op            <span class="number">1272</span> B/op         <span class="number">15</span> allocs/op</span><br><span class="line">PASS</span><br><span class="line">ok      command-line-arguments  <span class="number">6.027</span>s</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong><font color=red>经多次运行，发现反序列化(<code>Unmarshal</code>)比标准包快了2.5倍,而序列化(<code>Marshal</code>)基本没有什么很高的性能提升。</font></strong></p>
</blockquote>
<h2 id="1-3-为什么比encoding-json快？"><a href="#1-3-为什么比encoding-json快？" class="headerlink" title="1.3 为什么比encoding/json快？"></a>1.3 为什么比<code>encoding/json</code>快？</h2><p><code>jsoniter</code> 能够比<code>encoding/json</code>快的主要原因，</p>
<ul>
<li>减少不必要的内存复制。</li>
<li>减少 反射(<code>reflect</code>） 的使用，对同一类型的对象，<code>jsoniter </code>只反射一次之后即缓存下来。</li>
</ul>
<h1 id="2-下载"><a href="#2-下载" class="headerlink" title="2. 下载"></a>2. 下载</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> get github.com/json-iterator/<span class="keyword">go</span></span><br></pre></td></tr></table></figure>

<h1 id="3-使用"><a href="#3-使用" class="headerlink" title="3. 使用"></a>3. 使用</h1><h2 id="3-1-完全兼容encoding-json"><a href="#3-1-完全兼容encoding-json" class="headerlink" title="3.1 完全兼容encoding/json"></a>3.1 完全兼容<code>encoding/json</code></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> json = jsoniter.ConfigCompatibleWithStandardLibrary</span><br></pre></td></tr></table></figure>



<h2 id="3-2-序列化成string"><a href="#3-2-序列化成string" class="headerlink" title="3.2 序列化成string"></a>3.2 序列化成<code>string</code></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 序列化成字符串</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestMarshalToString</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	order := Order&#123;</span><br><span class="line">		Id:       <span class="number">10</span>,</span><br><span class="line">		OrderNum: <span class="string">&quot;100200300&quot;</span>,</span><br><span class="line">		Money:    <span class="number">99.99</span>,</span><br><span class="line">		PayTime:  time.Now(),</span><br><span class="line">		Extend:   <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span>&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 直接转成字符串</span></span><br><span class="line">	jsonStr, _ := jsoniter.MarshalToString(order)</span><br><span class="line">	fmt.Println(<span class="string">&quot;jsonStr:&quot;</span>, jsonStr)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**输出</span></span><br><span class="line"><span class="comment">=== RUN   TestMarshalToString</span></span><br><span class="line"><span class="comment">jsonStr: &#123;&quot;id&quot;:10,&quot;orderNum&quot;:&quot;100200300&quot;,&quot;money&quot;:99.99,&quot;payTime&quot;:&quot;2021-12-28T23:44:36.258311+08:00&quot;,&quot;extend&quot;:&#123;&quot;name&quot;:&quot;张三&quot;&#125;&#125;</span></span><br><span class="line"><span class="comment">--- PASS: TestMarshalToString (0.00s)</span></span><br><span class="line"><span class="comment">PASS</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="3-3-序列化成-byte"><a href="#3-3-序列化成-byte" class="headerlink" title="3.3 序列化成[]byte"></a>3.3 序列化成<code>[]byte</code></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 序列化成[]byte</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestMarshalToByte</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	order := Order&#123;</span><br><span class="line">		Id:       <span class="number">10</span>,</span><br><span class="line">		OrderNum: <span class="string">&quot;100200300&quot;</span>,</span><br><span class="line">		Money:    <span class="number">99.99</span>,</span><br><span class="line">		PayTime:  time.Now(),</span><br><span class="line">		Extend:   <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span>&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 转成字节[]byte</span></span><br><span class="line">	marshal, _ := jsoniter.Marshal(order)</span><br><span class="line">	fmt.Println(<span class="string">&quot;marshal:&quot;</span>, marshal)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**输出</span></span><br><span class="line"><span class="comment">=== RUN   TestMarshalToByte</span></span><br><span class="line"><span class="comment">marshal: [123 34 105 100 34 58 49 48 44 34 111 114 100 101 114 78 117 109 34 58 34 49 48 48 50 48 48 51 48 48 34 44 34 109 111 110 101 121 34 58 57 57 46 57 57 44 34 112 97 121 84 105 109 101 34 58 34 50 48 50 49 45 49 50 45 50 56 84 50 51 58 52 54 58 49 51 46 49 48 53 52 54 54 43 48 56 58 48 48 34 44 34 101 120 116 101 110 100 34 58 123 34 110 97 109 101 34 58 34 229 188 160 228 184 137 34 125 125]</span></span><br><span class="line"><span class="comment">--- PASS: TestMarshalToByte (0.00s)</span></span><br><span class="line"><span class="comment">PASS</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="3-4-反序列化"><a href="#3-4-反序列化" class="headerlink" title="3.4 反序列化"></a>3.4 反序列化</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 反序列化</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestUnmarshalTmp</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	str := <span class="string">`&#123;&quot;id&quot;:10,&quot;orderNum&quot;:&quot;100200300&quot;,&quot;money&quot;:99.99,&quot;payTime&quot;:&quot;2021-12-28T23:44:36.258311+08:00&quot;,&quot;extend&quot;:&#123;&quot;name&quot;:&quot;张三&quot;&#125;&#125;`</span></span><br><span class="line">	<span class="keyword">var</span> order Order</span><br><span class="line">	<span class="comment">// 从字符串反序列化</span></span><br><span class="line">	_ = jsoniter.UnmarshalFromString(str, &amp;order)</span><br><span class="line">	fmt.Println(<span class="string">&quot;order:&quot;</span>, order)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> order2 Order</span><br><span class="line">	<span class="comment">// 从[]byte反序列化</span></span><br><span class="line">	_ = jsoniter.Unmarshal([]<span class="type">byte</span>(str), &amp;order2)</span><br><span class="line">	fmt.Println(<span class="string">&quot;order2:&quot;</span>, order2)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**输出</span></span><br><span class="line"><span class="comment">=== RUN   TestUnmarshalTmp</span></span><br><span class="line"><span class="comment">order: &#123;10 100200300 99.99 2021-12-28 23:44:36.258311 +0800 CST map[name:张三]&#125;</span></span><br><span class="line"><span class="comment">order2: &#123;10 100200300 99.99 2021-12-28 23:44:36.258311 +0800 CST map[name:张三]&#125;</span></span><br><span class="line"><span class="comment">--- PASS: TestUnmarshalTmp (0.00s)</span></span><br><span class="line"><span class="comment">PASS</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="3-5-类型不匹配场景"><a href="#3-5-类型不匹配场景" class="headerlink" title="3.5 类型不匹配场景"></a>3.5 类型不匹配场景</h2><h2 id="1-结构体定义"><a href="#1-结构体定义" class="headerlink" title="1. 结构体定义"></a>1. 结构体定义</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Order <span class="keyword">struct</span> &#123;</span><br><span class="line">	Id       <span class="type">int</span>               <span class="string">`json:&quot;id,omitempty&quot;`</span></span><br><span class="line">	OrderNum <span class="type">string</span>            <span class="string">`json:&quot;orderNum,omitempty&quot;`</span></span><br><span class="line">	Money    <span class="type">float64</span>           <span class="string">`json:&quot;money,omitempty&quot;`</span></span><br><span class="line">	PayTime  time.Time         <span class="string">`json:&quot;payTime&quot;`</span></span><br><span class="line">	Extend   <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;extend&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-encoding-json"><a href="#2-encoding-json" class="headerlink" title="2. encoding/json"></a>2. <code>encoding/json</code></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用encoding/json反序列化</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestTypeCovert</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	<span class="comment">// money 为float64类型，故意设置成字符串</span></span><br><span class="line">	str := <span class="string">`&#123;&quot;id&quot;:10,&quot;orderNum&quot;:&quot;100200300&quot;,&quot;money&quot;:&quot;99.99&quot;,&quot;payTime&quot;:&quot;2021-12-28T23:44:36.258311+08:00&quot;,&quot;extend&quot;:&#123;&quot;name&quot;:&quot;张三&quot;&#125;&#125;`</span></span><br><span class="line">	<span class="keyword">var</span> order Order</span><br><span class="line">	<span class="comment">// 使用标准库解析</span></span><br><span class="line">	err := json.Unmarshal([]<span class="type">byte</span>(str), &amp;order)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;json err:&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;order: &quot;</span>, order)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**输出</span></span><br><span class="line"><span class="comment">=== RUN   TestTypeCovert</span></span><br><span class="line"><span class="comment">json err: json: cannot unmarshal string into Go struct field Order.money of type float64</span></span><br><span class="line"><span class="comment">order:  &#123;10 100200300 0 2021-12-28 23:44:36.258311 +0800 CST map[name:张三]&#125;</span></span><br><span class="line"><span class="comment">--- PASS: TestTypeCovert (0.00s)</span></span><br><span class="line"><span class="comment">PASS</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="3-json-iterator"><a href="#3-json-iterator" class="headerlink" title="3. json-iterator"></a>3. <code>json-iterator</code></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用json-iterator反序列化</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestTypeCovertWithJsonIter</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	<span class="comment">// money 为float64类型，故意设置成字符串</span></span><br><span class="line">	str := <span class="string">`&#123;&quot;id&quot;:10,&quot;orderNum&quot;:&quot;100200300&quot;,&quot;money&quot;:&quot;99.99&quot;,&quot;payTime&quot;:&quot;2021-12-28T23:44:36.258311+08:00&quot;,&quot;extend&quot;:&#123;&quot;name&quot;:&quot;张三&quot;&#125;&#125;`</span></span><br><span class="line">	<span class="keyword">var</span> order Order</span><br><span class="line">	<span class="comment">// 定义</span></span><br><span class="line">	<span class="keyword">var</span> jsonNew = jsoniter.ConfigCompatibleWithStandardLibrary</span><br><span class="line">	<span class="comment">// 自适应类型</span></span><br><span class="line">	extra.RegisterFuzzyDecoders()</span><br><span class="line">	err := jsonNew.Unmarshal([]<span class="type">byte</span>(str), &amp;order)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;jsonNew err:&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;order: &quot;</span>, order)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**输出</span></span><br><span class="line"><span class="comment">=== RUN   TestTypeCovertWithJsonIter</span></span><br><span class="line"><span class="comment">order:  &#123;10 100200300 99.99 2021-12-28 23:44:36.258311 +0800 CST map[name:张三]&#125;</span></span><br><span class="line"><span class="comment">--- PASS: TestTypeCovertWithJsonIter (0.00s)</span></span><br><span class="line"><span class="comment">PASS</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="3-6-处理私有属性"><a href="#3-6-处理私有属性" class="headerlink" title="3.6 处理私有属性"></a>3.6 处理私有属性</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义结构体，里面包含私有属性</span></span><br><span class="line"><span class="keyword">type</span> Demo <span class="keyword">struct</span> &#123;</span><br><span class="line">	FirstName <span class="type">string</span> <span class="string">`json:&quot;firstName,omitempty&quot;`</span></span><br><span class="line">	lastName  <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析私有属性</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestDealPrivate</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	d := Demo&#123;</span><br><span class="line">		FirstName: <span class="string">&quot;张&quot;</span>,</span><br><span class="line">		lastName:  <span class="string">&quot;三丰&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 开启解析私有属性，注：私有属性不能有json标签，否则不能解析</span></span><br><span class="line">	extra.SupportPrivateFields()</span><br><span class="line">	<span class="keyword">var</span> jsonNew = jsoniter.ConfigCompatibleWithStandardLibrary</span><br><span class="line">	res, err := jsonNew.MarshalToString(d)</span><br><span class="line">	fmt.Println(<span class="string">&quot;序列化-err:&quot;</span>, err)</span><br><span class="line">	fmt.Println(<span class="string">&quot;序列化-res:&quot;</span>, res)</span><br><span class="line">	<span class="comment">// 反序列化私有属性</span></span><br><span class="line">	jsonStr := <span class="string">`&#123;&quot;firstName&quot;:&quot;张&quot;,&quot;lastName&quot;:&quot;三丰&quot;&#125;`</span></span><br><span class="line">	<span class="keyword">var</span> d2 Demo</span><br><span class="line">	err = jsonNew.UnmarshalFromString(jsonStr, &amp;d2)</span><br><span class="line">	fmt.Println(<span class="string">&quot;反序列化-err:&quot;</span>, err)</span><br><span class="line">	fmt.Println(<span class="string">&quot;反序列化-d2:&quot;</span>, d2)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**输出</span></span><br><span class="line"><span class="comment">=== RUN   TestDealPrivate</span></span><br><span class="line"><span class="comment">序列化-err: &lt;nil&gt;</span></span><br><span class="line"><span class="comment">序列化-res: &#123;&quot;firstName&quot;:&quot;张&quot;,&quot;lastName&quot;:&quot;三丰&quot;&#125;</span></span><br><span class="line"><span class="comment">反序列化-err: &lt;nil&gt;</span></span><br><span class="line"><span class="comment">反序列化-d2: &#123;张 三丰&#125;</span></span><br><span class="line"><span class="comment">--- PASS: TestDealPrivate (0.00s)</span></span><br><span class="line"><span class="comment">PASS</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="3-7-时间类型处理"><a href="#3-7-时间类型处理" class="headerlink" title="3.7 时间类型处理"></a>3.7 时间类型处理</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> timeDemo <span class="keyword">struct</span> &#123;</span><br><span class="line">	CreateTime time.Time <span class="string">`json:&quot;createTime&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 解析时间</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestDealTime</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	td := timeDemo&#123;CreateTime: time.Now()&#125;</span><br><span class="line">	<span class="keyword">var</span> jsonNew = jsoniter.ConfigCompatibleWithStandardLibrary</span><br><span class="line">	<span class="comment">// 转成以秒</span></span><br><span class="line">	extra.RegisterTimeAsInt64Codec(time.Second)</span><br><span class="line">	<span class="comment">// 序列化</span></span><br><span class="line">	res, err := jsonNew.MarshalToString(td)</span><br><span class="line">	fmt.Println(<span class="string">&quot;时间序列化-err:&quot;</span>, err)</span><br><span class="line">	fmt.Println(<span class="string">&quot;时间序列化-res:&quot;</span>, res)</span><br><span class="line">	<span class="comment">// 反序列化</span></span><br><span class="line">	str := <span class="string">`&#123;&quot;createTime&quot;:1640791445&#125;`</span></span><br><span class="line">	<span class="keyword">var</span> tds timeDemo</span><br><span class="line">	err = jsonNew.UnmarshalFromString(str, &amp;tds)</span><br><span class="line">	fmt.Println(<span class="string">&quot;时间反序列化-err:&quot;</span>, err)</span><br><span class="line">	fmt.Println(<span class="string">&quot;时间反序列化-res:&quot;</span>, tds)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**输出</span></span><br><span class="line"><span class="comment">type timeDemo struct &#123;</span></span><br><span class="line"><span class="comment">	CreateTime time.Time `json:&quot;createTime&quot;`</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">// 解析时间</span></span><br><span class="line"><span class="comment">=== RUN   TestDealTime</span></span><br><span class="line"><span class="comment">时间序列化-err: &lt;nil&gt;</span></span><br><span class="line"><span class="comment">时间序列化-res: &#123;&quot;createTime&quot;:1640792397&#125;</span></span><br><span class="line"><span class="comment">时间反序列化-err: &lt;nil&gt;</span></span><br><span class="line"><span class="comment">时间反序列化-res: &#123;2021-12-29 23:24:05 +0800 CST&#125;</span></span><br><span class="line"><span class="comment">--- PASS: TestDealTime (0.00s)</span></span><br><span class="line"><span class="comment">PASS</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="3-8-直接读取Json字符串"><a href="#3-8-直接读取Json字符串" class="headerlink" title="3.8 直接读取Json字符串"></a>3.8 直接读取<code>Json</code>字符串</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 直接读取json 字符串</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestReadJsonString</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	str := <span class="string">`&#123;</span></span><br><span class="line"><span class="string">    &quot;id&quot;:10,</span></span><br><span class="line"><span class="string">    &quot;extend&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;name&quot;:&quot;张三&quot;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;desc&quot;:[</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;score&quot;:&quot;100&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;score&quot;:&quot;90&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;`</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;id:&quot;</span>, jsoniter.Get([]<span class="type">byte</span>(str), <span class="string">&quot;id&quot;</span>).ToInt())</span><br><span class="line">	fmt.Println(<span class="string">&quot;extend.name:&quot;</span>, jsoniter.Get([]<span class="type">byte</span>(str), <span class="string">&quot;extend&quot;</span>, <span class="string">&quot;name&quot;</span>).ToString())</span><br><span class="line">	fmt.Println(<span class="string">&quot;desc.0.score:&quot;</span>, jsoniter.Get([]<span class="type">byte</span>(str), <span class="string">&quot;desc&quot;</span>, <span class="number">0</span>, <span class="string">&quot;score&quot;</span>).ToInt())</span><br><span class="line">	fmt.Println(<span class="string">&quot;desc.1.score:&quot;</span>, jsoniter.Get([]<span class="type">byte</span>(str), <span class="string">&quot;desc&quot;</span>, <span class="number">1</span>, <span class="string">&quot;score&quot;</span>).ToInt())</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**输出</span></span><br><span class="line"><span class="comment">=== RUN   TestReadJsonString</span></span><br><span class="line"><span class="comment">id: 10</span></span><br><span class="line"><span class="comment">extend.name: 张三</span></span><br><span class="line"><span class="comment">desc.0.score: 100</span></span><br><span class="line"><span class="comment">desc.1.score: 90</span></span><br><span class="line"><span class="comment">--- PASS: TestReadJsonString (0.00s)</span></span><br><span class="line"><span class="comment">PASS</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="3-9-大驼峰转下划线"><a href="#3-9-大驼峰转下划线" class="headerlink" title="3.9 大驼峰转下划线"></a>3.9 大驼峰转下划线</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PayInfo <span class="keyword">struct</span> &#123;</span><br><span class="line">	OrderId  <span class="type">int</span></span><br><span class="line">	PayMoney <span class="type">float64</span> <span class="string">`json:&quot;payMoney&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 没有json标签的大驼峰属性，会转成下划线变量</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSetNamingStrategy</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	payInfo := PayInfo&#123;</span><br><span class="line">		OrderId:  <span class="number">100</span>,</span><br><span class="line">		PayMoney: <span class="number">9.9</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// -------- 序列化 --------</span></span><br><span class="line">	<span class="comment">// 设置后，没有json标签的属性，会自动转成 xx_xx</span></span><br><span class="line">	extra.SetNamingStrategy(extra.LowerCaseWithUnderscores)</span><br><span class="line">	res, _ := jsoniter.MarshalToString(payInfo)</span><br><span class="line">	fmt.Println(<span class="string">&quot;序列化:&quot;</span>, res)</span><br><span class="line">	<span class="comment">// -------- 反序列化 --------</span></span><br><span class="line">	<span class="keyword">var</span> p PayInfo</span><br><span class="line">	_ = jsoniter.UnmarshalFromString(res, &amp;p)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;反序列化:%+v \n&quot;</span>, p)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**输出</span></span><br><span class="line"><span class="comment">=== RUN   TestSetNamingStrategy</span></span><br><span class="line"><span class="comment">序列化: &#123;&quot;order_id&quot;:100,&quot;payMoney&quot;:9.9&#125;</span></span><br><span class="line"><span class="comment">反序列化:&#123;OrderId:100 PayMoney:9.9&#125; </span></span><br><span class="line"><span class="comment">--- PASS: TestSetNamingStrategy (0.00s)</span></span><br><span class="line"><span class="comment">PASS</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong><font color=blue>@设置<code>SetNamingStrategy</code>后，有<code>json</code>标签的使用<code>json</code>标签，没有的则会自动转成xx_xx</font></strong></p>
<h1 id="4-避坑-concurrent-map-writes"><a href="#4-避坑-concurrent-map-writes" class="headerlink" title="4. 避坑:concurrent map writes"></a>4. 避坑:<code>concurrent map writes</code></h1><p><strong><font color=red>@设置<code>extra.RegisterFuzzyDecoders()</code>时，注意不要在多个协程中重复设置，在init函数执行一次即可，否则会报错：fatal error: concurrent map writes</font></strong></p>
<h2 id="4-1-错误使用"><a href="#4-1-错误使用" class="headerlink" title="4.1 错误使用"></a>4.1 错误使用</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestUseRegisterFuzzyDecodersWithGoroutine</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	payInfo := PayInfo&#123;</span><br><span class="line">		OrderId:  <span class="number">100</span>,</span><br><span class="line">		PayMoney: <span class="number">9.9</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 在多个协程中设置extra.RegisterFuzzyDecoders()</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			jsonNew := jsoniter.ConfigCompatibleWithStandardLibrary</span><br><span class="line">			extra.RegisterFuzzyDecoders()</span><br><span class="line">			_, _ = jsonNew.MarshalToString(payInfo)</span><br><span class="line">		&#125;()</span><br><span class="line">	&#125;</span><br><span class="line">	time.Sleep(time.Second * <span class="number">1</span>)</span><br><span class="line">	fmt.Println(<span class="string">&quot;ok&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**报错</span></span><br><span class="line"><span class="comment">=== RUN   TestUseRegisterFuzzyDecodersWithGoroutine</span></span><br><span class="line"><span class="comment">fatal error: concurrent map writes</span></span><br><span class="line"><span class="comment">fatal error: concurrent map writes</span></span><br><span class="line"><span class="comment">fatal error: concurrent map writes</span></span><br><span class="line"><span class="comment">....</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="4-2-正确使用"><a href="#4-2-正确使用" class="headerlink" title="4.2 正确使用"></a>4.2 正确使用</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 在init中设置一次即可</span></span><br><span class="line">	extra.RegisterFuzzyDecoders()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestUseRegisterFuzzyDecodersWithGoroutine</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	payInfo := PayInfo&#123;</span><br><span class="line">		OrderId:  <span class="number">100</span>,</span><br><span class="line">		PayMoney: <span class="number">9.9</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 在多个协程中设置extra.RegisterFuzzyDecoders()</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			jsonNew := jsoniter.ConfigCompatibleWithStandardLibrary</span><br><span class="line">			_, _ = jsonNew.MarshalToString(payInfo)</span><br><span class="line">		&#125;()</span><br><span class="line">	&#125;</span><br><span class="line">	time.Sleep(time.Second * <span class="number">1</span>)</span><br><span class="line">	fmt.Println(<span class="string">&quot;ok&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**输出</span></span><br><span class="line"><span class="comment">=== RUN   TestUseRegisterFuzzyDecodersWithGoroutine</span></span><br><span class="line"><span class="comment">ok</span></span><br><span class="line"><span class="comment">--- PASS: TestUseRegisterFuzzyDecodersWithGoroutine (1.00s)</span></span><br><span class="line"><span class="comment">PASS</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://blog.shershon.top">谭晓珊</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://blog.shershon.top/2021/05/03/%E7%BC%96%E7%A8%8B/Go/%E6%89%A9%E5%B1%95%E5%8C%85/30-jsoniter/">http://blog.shershon.top/2021/05/03/%E7%BC%96%E7%A8%8B/Go/%E6%89%A9%E5%B1%95%E5%8C%85/30-jsoniter/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://blog.shershon.top" target="_blank">码农小山</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Go%E6%89%A9%E5%B1%95%E5%8C%85/">Go扩展包</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/shershon1991/picImgBed/master/personal/21358691.jpeg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://raw.githubusercontent.com/shershon1991/picImgBed/master/personal/reward_wechat.jpeg" target="_blank"><img class="post-qr-code-img" src="https://raw.githubusercontent.com/shershon1991/picImgBed/master/personal/reward_wechat.jpeg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://raw.githubusercontent.com/shershon1991/picImgBed/master/personal/reward_alipay.jpeg" target="_blank"><img class="post-qr-code-img" src="https://raw.githubusercontent.com/shershon1991/picImgBed/master/personal/reward_alipay.jpeg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/06/01/%E7%BC%96%E7%A8%8B/Go/%E6%A1%86%E6%9E%B6%E5%BC%80%E5%8F%91/1-%E6%A1%86%E6%9E%B6%E5%BC%80%E5%8F%91-%E7%9B%AE%E5%BD%95%E4%BB%8B%E7%BB%8D%E5%92%8C%E8%B7%AF%E7%94%B1%E8%AE%BE%E8%AE%A1/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">框架开发(一):框架开发-目录介绍和路由设计</div></div></a></div><div class="next-post pull-right"><a href="/2021/05/02/%E7%BC%96%E7%A8%8B/Go/%E6%89%A9%E5%B1%95%E5%8C%85/29-go-funk/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Go扩展包(二十九):go-funk</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/04/01/%E7%BC%96%E7%A8%8B/Go/%E6%89%A9%E5%B1%95%E5%8C%85/1-strings(%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%93%8D%E4%BD%9C)/" title="Go扩展包(一):strings(字符串操作)"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-01</div><div class="title">Go扩展包(一):strings(字符串操作)</div></div></a></div><div><a href="/2021/04/10/%E7%BC%96%E7%A8%8B/Go/%E6%89%A9%E5%B1%95%E5%8C%85/10-viper/" title="Go扩展包(十):viper"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-10</div><div class="title">Go扩展包(十):viper</div></div></a></div><div><a href="/2021/04/11/%E7%BC%96%E7%A8%8B/Go/%E6%89%A9%E5%B1%95%E5%8C%85/11-sort/" title="Go扩展包(十一):sort"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-11</div><div class="title">Go扩展包(十一):sort</div></div></a></div><div><a href="/2021/04/12/%E7%BC%96%E7%A8%8B/Go/%E6%89%A9%E5%B1%95%E5%8C%85/12-unicode/" title="Go扩展包(十二):unicode"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-12</div><div class="title">Go扩展包(十二):unicode</div></div></a></div><div><a href="/2021/04/14/%E7%BC%96%E7%A8%8B/Go/%E6%89%A9%E5%B1%95%E5%8C%85/14-bigCache/" title="Go扩展包(十四):bigCache"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-14</div><div class="title">Go扩展包(十四):bigCache</div></div></a></div><div><a href="/2021/04/13/%E7%BC%96%E7%A8%8B/Go/%E6%89%A9%E5%B1%95%E5%8C%85/13-zap/" title="Go扩展包(十三):zap"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-13</div><div class="title">Go扩展包(十三):zap</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://raw.githubusercontent.com/shershon1991/picImgBed/master/personal/21358691.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">谭晓珊</div><div class="author-info__description">生活幸福，健康快乐！</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">177</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">35</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">23</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/shershon1991"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/shershon1991" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:18810877074@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">新人报道，请大家多多关照！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E4%BB%8B%E7%BB%8D"><span class="toc-text">1. 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%AE%98%E7%BD%91%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E5%9B%BE"><span class="toc-text">1.1 官网性能对比图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E8%87%AA%E5%86%99%E7%A8%8B%E5%BA%8F%E9%AA%8C%E8%AF%81"><span class="toc-text">1.2 自写程序验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%AF%94encoding-json%E5%BF%AB%EF%BC%9F"><span class="toc-text">1.3 为什么比encoding&#x2F;json快？</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E4%B8%8B%E8%BD%BD"><span class="toc-text">2. 下载</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E4%BD%BF%E7%94%A8"><span class="toc-text">3. 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E5%AE%8C%E5%85%A8%E5%85%BC%E5%AE%B9encoding-json"><span class="toc-text">3.1 完全兼容encoding&#x2F;json</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E5%BA%8F%E5%88%97%E5%8C%96%E6%88%90string"><span class="toc-text">3.2 序列化成string</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E5%BA%8F%E5%88%97%E5%8C%96%E6%88%90-byte"><span class="toc-text">3.3 序列化成[]byte</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-text">3.4 反序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E7%B1%BB%E5%9E%8B%E4%B8%8D%E5%8C%B9%E9%85%8D%E5%9C%BA%E6%99%AF"><span class="toc-text">3.5 类型不匹配场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%BB%93%E6%9E%84%E4%BD%93%E5%AE%9A%E4%B9%89"><span class="toc-text">1. 结构体定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-encoding-json"><span class="toc-text">2. encoding&#x2F;json</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-json-iterator"><span class="toc-text">3. json-iterator</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-%E5%A4%84%E7%90%86%E7%A7%81%E6%9C%89%E5%B1%9E%E6%80%A7"><span class="toc-text">3.6 处理私有属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-7-%E6%97%B6%E9%97%B4%E7%B1%BB%E5%9E%8B%E5%A4%84%E7%90%86"><span class="toc-text">3.7 时间类型处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-8-%E7%9B%B4%E6%8E%A5%E8%AF%BB%E5%8F%96Json%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-text">3.8 直接读取Json字符串</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-9-%E5%A4%A7%E9%A9%BC%E5%B3%B0%E8%BD%AC%E4%B8%8B%E5%88%92%E7%BA%BF"><span class="toc-text">3.9 大驼峰转下划线</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E9%81%BF%E5%9D%91-concurrent-map-writes"><span class="toc-text">4. 避坑:concurrent map writes</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E9%94%99%E8%AF%AF%E4%BD%BF%E7%94%A8"><span class="toc-text">4.1 错误使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8"><span class="toc-text">4.2 正确使用</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/03/02/%E7%BC%96%E7%A8%8B/PHP/PHP%E6%89%A9%E5%B1%95/4-jwt/" title="php扩展(四):jwt">php扩展(四):jwt</a><time datetime="2023-03-01T16:00:00.000Z" title="发表于 2023-03-02 00:00:00">2023-03-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/02/27/%E7%BC%96%E7%A8%8B/Go/%E8%BF%9B%E9%98%B6%E7%AF%87/%E5%BA%95%E5%B1%82%E6%8E%A2%E7%B4%A2/01-%E7%BC%96%E8%AF%91%E5%99%A8/" title="Go底层探索(一):编译器">Go底层探索(一):编译器</a><time datetime="2023-02-26T16:00:00.000Z" title="发表于 2023-02-27 00:00:00">2023-02-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/10/05/%E7%BC%96%E7%A8%8B/Go/%E6%89%A9%E5%B1%95%E5%8C%85/31-rocketmq/" title="Go扩展包(三十一):rocketmq">Go扩展包(三十一):rocketmq</a><time datetime="2022-10-04T16:00:00.000Z" title="发表于 2022-10-05 00:00:00">2022-10-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/09/30/%E7%BC%96%E7%A8%8B/PHP/PHP%E6%89%A9%E5%B1%95/3-rocketmq/" title="php扩展(三):阿里云RocketMQ">php扩展(三):阿里云RocketMQ</a><time datetime="2022-09-29T16:00:00.000Z" title="发表于 2022-09-30 00:00:00">2022-09-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/09/25/%E7%BC%96%E7%A8%8B/Go/%E8%BF%9B%E9%98%B6%E7%AF%87/rpc/06-gRPC%E4%B8%AD%E7%9A%84%E6%88%AA%E5%8F%96%E5%99%A8/" title="RPC编程(六):gRPC中的截取器">RPC编程(六):gRPC中的截取器</a><time datetime="2022-09-25T00:03:00.000Z" title="发表于 2022-09-25 08:03:00">2022-09-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By 谭晓珊</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a><br><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn">鄂ICP备2022015295号-1</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/algoliasearch-lite.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'YjWLdM2rBo9Vj9GlbMghmKFc-gzGzoHsz',
      appKey: 'Vic4lHitiOVBpUuCtQcEwmCI',
      avatar: 'wavatar',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script>(function(d, w, c) {
    w.ChatraID = 'Cqd4CQF7bWHcxHyNs';
    var s = d.createElement('script');
    w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments);
    };
    s.async = true;
    s.src = 'https://call.chatra.io/chatra.js';
    if (d.head) d.head.appendChild(s);
})(document, window, 'Chatra');

if (true) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      Chatra('openChat')
    });
  }
  chatBtnFn()
} else {
  if (false) {
    function chatBtnHide () {
      Chatra('hide')
    }
    function chatBtnShow () {
      Chatra('show')
    }
  }
}</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>